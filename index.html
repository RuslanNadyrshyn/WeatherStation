<!doctype html> <!-- html код -->
<html>

<head>
    <meta charset="utf-8"> <!-- Підключення кирилиці -->
    <link rel="stylesheet" href="css/style.css">
    <script src="js/chart.min.js"></script> <!-- Підключення додаткових бібліотек -->
    <script src="js/utils.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/script.js"></script>
</head>

<body>
    <header>
        <nav>
            <div class="weather-container">
                <div class="dropdown">
                    <a id="location">Львів</a>
                    <nav class="dropdown-content">
                        <a onclick="changeLocation('Київ')">Київ</a>
                        <a onclick="changeLocation('Львів')">Львів</a>
                        <a onclick="changeLocation('Харків')">Харків</a>
                    </nav>
                </div>
                <div class="dropdown-weather">
                    <div id="location-weather">-1</div>
                    <div class="weather-block">
                        <div class="weather-content">
                            <table id="weatherTable"></table>
                            <a href="https://www.meteo.gov.ua/">Докладніше</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-menu">
                <a href="#current-label">Дані датчика BME280</a>
                <a href="#db-label">База даних</a>
                <a href="#charts-label">Графіки</a>
            </div>
        </nav>
    </header>
    <div class="container">
        <h1 id="current-label">Дані датчика BME280</h1> <!-- Створення таблиці "Дані датчика BME280" -->
        <table class="current-table" cellspacing="0">
            <tr>
                <th>Температура</th>
                <th>Тиск</th>
                <th>Висота над рівнем моря</th>
                <th>Вологість</th>
            </tr>
            <tr>
                <td class="current-table-td" id="temp">21.5</td>
                <td class="current-table-td" id="press">1001 ГПа</td>
                <td class="current-table-td" id="alt">800 м</td>
                <td class="current-table-td" id="hum">67 %</td>
            </tr>
        </table>
        <h1 id="db-label">База даних</h1>
        <button onclick="updateTable()">Update table</button>
        <nav class="navigator-block">
            Сторінка:
            <a class="navigator-item" onclick="window.location='index.php?count=20';">1</a>
            <a class="navigator-item" onclick="window.location='index.php?count=20';">2</a>
            <a class="navigator-item" onclick="window.location='index.php?count=20';">3</a>
            <a class="navigator-item" onclick="window.location='index.php?count=20';">5</a>
        </nav>
        <!-- Вивід навігатора сторінок і кількості значень БД -->
        <div class="db-table-container">
            <table id="dbTable"></table>
        </div>
        <nav class="navigator-block">
            <a class="navigator-item" onclick="window.location='index.php?count=20';">20</a>
            <a class="navigator-item" onclick="window.location='index.php?count=50';">50</a>
            <a class="navigator-item" onclick="window.location='index.php?count=100';">100</a>
            <a class="navigator-item" onclick="window.location='index.php?count=';">Всі()</a>
        </nav>
        <!-- Вивід навігатора сторінок БД -->
        <h1 id="charts-label">Графіки</h1>
        <p>*Натисніть на графік для його збільшення</p>
        <div class="chart-block">
            <!--Ініціалізація графіків -->
            <div class="chart-container" onclick="toggleChart({id})" id="container-temp">
                <label class="chart-label">Температура</label>
                <canvas id="chart-temp"></canvas>
            </div>
            <div class="chart-container" onclick="toggleChart({id})" id="container-press">
                <label class="chart-label">Тиск</label>
                <canvas id="chart-press"></canvas>
            </div>
            <div class="chart-container" onclick="toggleChart({id})" id="container-alt">
                <label class="chart-label">Висота над рівнем моря</label>
                <canvas id="chart-alt"></canvas>
            </div>
            <div class="chart-container" onclick="toggleChart({id})" id="container-hum">
                <label class="chart-label">Вологість</label>
                <canvas id="chart-hum"></canvas>
            </div>
        </div>
    </div> <!-- container -->
    <script>
        function changeLocation(Location) {
            const loc = document.getElementById('location');

            // ✅ Change button text on click
            loc.textContent = Location;
        }

        var db = [];
        for (let i = 0; i < 15; i++) {
            db.push({
                id: i,
                date: "date" + i,
                time: "time" + i,
                temp: "temp" + i,
                press: "press" + i,
                alt: "alt" + i,
                hum: "hum" + i
            })
        }
        var arr = [];
        for (let i = 0; i < 100; i++) {
            arr.push(i);
        }
        var header = ["ID", "Дата", "Час", "Температура", "Тиск", "Висота", "Вологість"];
        var weatherHeader = ["", "Температура", "Вологість"];

        weatherData = [
            {
                title: "Ранок",
                temp: 15 + " °С",
                hum: 60 + " %"
            },
            {
                title: "День",
                temp: 15 + " °С",
                hum: 60 + " %"
            },
            {
                title: "Вечір",
                temp: 15 + " °С",
                hum: 60 + " %"
            },
            {
                title: "Ніч",
                temp: 15 + " °С",
                hum: 60 + " %"
            },
            {
                title: "Зараз",
                temp: 15 + " °С",
                hum: 60 + " %"
            },
        ]
        printWeather(weatherData, weatherHeader);
        printDB(db, header);
        drawCharts(arr, arr);

        function updateTable() {
            for (let i = 0; i < 15; i++) {
                db[i].id += 5;
                db[i].date += 5;
            }
            printDB(db, header);
        }

        function printRow(object, isHeader) {
            var $line = $("<tr></tr>");
            if (isHeader) object.forEach(element =>
                $line.append($("<th class='sticky'></th>").html(element)));
            else {
                for (const key in object)
                    if (Object.hasOwnProperty.call(object, key)) {
                        if (key == "date_bme280") {
                            datetime = object[key].split(" ");
                            date = datetime[0];
                            time = datetime[1];
                            $line.append($("<td></td>").html(date));
                            $line.append($("<td></td>").html(time));
                        } else $line.append($("<td></td>").html(object[key]));
                    }

            }
            return $line;
        }

        function createTable(data, header) {
            var $table = $("<table cellspacing='0'></table>");
            $table.append(printRow(header, true));
            for (let index = 0; index < data.length; index++) {
                var element = data[index];
                var $line = $("<tr></tr>");
                $table.append(printRow(element), false);
            }
            return $table;
        }

        function printWeather(data, header) {
            var $table = createTable(data, header);
            $("#weatherTable").empty();
            $table.appendTo($("#weatherTable"));
        }

        function printDB(data, header) {
            var $table = createTable(data, header);
            $("#dbTable").empty();
            $table.appendTo($("#dbTable"));
        }

        function printCharts(data) {
            var res = fetchResult(data);
            drawCharts(res, res.date);
        }

        function fetchResult(result) {
            var temp = [];
            var press = [];
            var alt = [];
            var hum = [];
            var date = [];

            result.forEach(element => {
                temp.push(element.temp_bme280);
                press.push(element.press_bme280);
                alt.push(element.alt_bme280);
                hum.push(element.hum_bme280);
                date.push(element.date_bme280);
            });

            return { temp, press, alt, hum, date };
        }

        function createConfig(labels, data, colorName) {
            return {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: colorName,
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        }
                    },
                    scales: {
                        y: {
                            offset: true
                        }
                    }
                }
            };
        }

        function drawCharts(res, labels) {
            window.onload = function () {
                [{
                    id: 'chart-temp',	// Графік температури
                    color: 'yellow',
                    data: arr,
                }, {
                    id: 'chart-press',	// Графік тиску
                    color: 'red',
                    data: arr,
                }, {
                    id: 'chart-alt', 	// Графік Висоти
                    color: 'green',
                    data: arr,
                }, {
                    id: 'chart-hum', 	// Графік вологості
                    color: 'blue',
                    data: arr,
                }].forEach(function (details) {
                    var ctx = document.getElementById(details.id).getContext('2d');
                    var config = createConfig(labels, details.data, details.color);
                    new Chart(ctx, config);
                });
            };
        }

        function toggleChart(id) {
            var element = document.getElementById(id.id);
            element.classList.toggle("large");
        }

    </script>
</body>

</html>